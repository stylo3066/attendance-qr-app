<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR de Prueba - Asistencia Profesores</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <style>
    :root{ --brand:#0f172a; --gold:#c5a351; }
    body{ font-family:'Inter',system-ui,sans-serif; background:#f8fafc; margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .card{ background:#fff; border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,.08); padding:24px; width:min(560px, 92vw); }
    h1{ font-size:1.25rem; margin:0 0 10px; color:var(--brand) }
    p{ color:#475569; margin:0 0 16px }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 18px }
    select,button{ padding:12px 14px; font-family:inherit; border-radius:10px; border:1px solid #e2e8f0; }
    button{ background:linear-gradient(135deg,var(--gold),#e9d69a); color:#1e293b; font-weight:600; cursor:pointer; border:1px solid rgba(197,163,81,.45) }
    .qrbox{ display:grid; place-items:center; border:1px dashed #cbd5e1; border-radius:12px; padding:18px; min-height:280px; }
    small{ color:#64748b }
    .badge{ background:#ecfeff; color:#0369a1; border:1px solid #bae6fd; padding:2px 8px; border-radius:999px; font-size:.8rem }
  </style>
  <script>
    // Datos de profesores de demostración
    const DEMO_PROFESSORS = [
      { id: "PROF001", nombre: "María", apellido: "González", materia: "Matemáticas" },
      { id: "PROF002", nombre: "Juan Carlos", apellido: "Rodríguez", materia: "Historia" },
      { id: "PROF003", nombre: "Ana Lucia", apellido: "Torres", materia: "Ciencias" },
      { id: "PROF004", nombre: "Carlos", apellido: "Mendoza", materia: "Literatura" },
      { id: "PROF005", nombre: "Patricia", apellido: "Sánchez", materia: "Educación Física" },
      { id: "PROF006", nombre: "Roberto", apellido: "García", materia: "Inglés" },
      { id: "PROF007", nombre: "Elena", apellido: "Martínez", materia: "Arte" },
      { id: "PROF008", nombre: "Miguel", apellido: "López", materia: "Música" }
    ];
    
    const api = `${window.location.origin}/api`;
    async function loadProfessors(){
      const sel = document.getElementById('prof');
      try{
        // Intentar cargar del servidor primero
        const res = await fetch(`${api}/professors`);
        const list = await res.json();
        sel.innerHTML = list.map(p=>`<option value="${p.id}">${p.id} — ${p.nombre} ${p.apellido} (${p.materia})</option>`).join('');
        if(list.length){ renderQR(list[0].id); }
      }catch(e){
        // Si falla, usar datos de demostración
        console.log('Usando datos de demostración (servidor no disponible)');
        sel.innerHTML = DEMO_PROFESSORS.map(p=>`<option value="${p.id}">${p.id} — ${p.nombre} ${p.apellido} (${p.materia})</option>`).join('');
        if(DEMO_PROFESSORS.length){ renderQR(DEMO_PROFESSORS[0].id); }
      }
    }
    function renderQR(text){
      const box = document.getElementById('qr');
      box.innerHTML = '';
      
      // Método 1: QRious (más confiable)
      if (window.QRious) {
        try {
          const canvas = document.createElement('canvas');
          const qr = new window.QRious({
            element: canvas,
            value: text,
            size: 260,
            background: 'white',
            foreground: 'black',
            level: 'M'
          });
          box.appendChild(canvas);
          document.getElementById('sample').textContent = text;
          return;
        } catch (e) {
          console.log('Error con QRious:', e);
        }
      }

      // Método 2: API externa como fallback
      try {
        const img = document.createElement('img');
        img.alt = 'QR Code';
        img.width = 260;
        img.height = 260;
        img.style.border = '1px solid #e2e8f0';
        img.style.borderRadius = '8px';
        img.src = `https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=${encodeURIComponent(text)}&bgcolor=FFFFFF&color=000000&margin=10`;
        
        img.onload = function() {
          console.log('QR generado exitosamente con API externa');
          document.getElementById('sample').textContent = text;
        };
        
        img.onerror = function() {
          console.log('Error cargando QR desde API externa');
          box.innerHTML = '<div style="color:#b91c1c; text-align:center; padding:20px;">❌ Error generando QR<br><small>Verifica tu conexión a internet</small></div>';
        };
        
        box.appendChild(img);
        return;
      } catch (e) {
        console.log('Error con API externa:', e);
      }

      // Si todo falla
      box.innerHTML = '<div style="color:#b91c1c; text-align:center; padding:20px;">❌ Error generando QR<br><small>Verifica tu conexión a internet o prueba recargando la página</small></div>';
      document.getElementById('sample').textContent = text || '—';
    }
    function onGenerate(){
      const id = document.getElementById('prof').value || 'PROF_001';
      console.log('Generando QR para:', id);
      
      // Mostrar indicador de carga
      const box = document.getElementById('qr');
      box.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">⏳ Generando QR...</div>';
      
      // Pequeño delay para mostrar el indicador
      setTimeout(() => {
        renderQR(id);
      }, 100);
    }
    
    // Debug: verificar qué librerías están disponibles
    window.addEventListener('load', function() {
      console.log('QRious disponible:', !!window.QRious);
      loadProfessors();
    });
  </script>
  </head>
<body>
  <div class="card">
    <h1>QR de Prueba – Asistencia</h1>
    <p>Selecciona un profesor y escanea el QR con la app móvil para registrar asistencia. <span class="badge">Texto QR = ID del profesor</span></p>
    <div class="row">
      <select id="prof" style="flex:1"></select>
      <button onclick="onGenerate()">Generar QR</button>
      <button onclick="renderQR('TEST123')" style="background:#28a745; border-color:#28a745;">Prueba</button>
    </div>
    <div class="qrbox" id="qr"></div>
    <p style="margin-top:10px"><small>Contenido del QR: <strong id="sample">—</strong></small></p>
  </div>
</body>
</html>
