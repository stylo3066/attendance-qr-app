<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=yes">
    <meta name="description" content="Dashboard ejecutivo para control de asistencia de profesores">
    <meta name="theme-color" content="#c5a351">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Dashboard Asistencia">
    <title>Sistema de Control de Asistencia - Dashboard Ejecutivo</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 35%, #334155 100%);
            --accent: #c5a351; /* dorado elegante */
            --accent-2: #8b6f2d;
            --card: rgba(255,255,255,0.92);
            --glass: rgba(255,255,255,0.06);
            --text: #1e293b;
            --muted: #64748b;
            --brand: #0f172a; /* azul marino muy oscuro */
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #2d3748;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: var(--card);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            position: relative;
            overflow: hidden;
        }

        .header::after{
            content:"";
            position:absolute; inset:0; pointer-events:none;
            background: linear-gradient(90deg, rgba(197,163,81,0.18), transparent 30%, transparent 70%, rgba(197,163,81,0.18));
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-title h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.3rem;
            font-weight: 700;
            letter-spacing: .3px;
            color: var(--brand);
        }
        
        .header-title .icon {
            font-size: 2.5rem;
            color: var(--accent);
        }
        
        .header-info {
            text-align: right;
            color: #64748b;
        }
        
        .current-time {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #10b981;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), #e9d69a);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }
        
        .stat-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stat-info {
            flex: 1;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
            line-height: 1;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-icon {
            font-size: 3rem;
            opacity: 0.18;
            color: var(--accent);
        }
        
        .stat-trend {
            margin-top: 10px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .trend-up {
            color: #10b981;
        }
        
        .trend-neutral {
            color: #64748b;
        }
        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .controls-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .controls-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e293b;
        }
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        input, select {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, #e9d69a 100%);
            color: #1e293b;
            box-shadow: 0 4px 15px rgba(197, 163, 81, 0.35);
            border: 1px solid rgba(197,163,81,0.35);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        .export-btn {
            background: #28a745;
        }
        .export-btn:hover {
            background: #218838;
        }
        .clear-btn {
            background: #dc3545;
        }
        .clear-btn:hover {
            background: #c82333;
        }
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .table-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 20px 30px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }
        
        th {
            background: #f9fafb;
            font-weight: 600;
            color: #475569;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid rgba(197,163,81,0.25);
        }
        
        tbody tr {
            transition: all 0.2s ease;
        }
        
        tbody tr:hover {
            background: rgba(197, 163, 81, 0.06);
            transform: scale(1.01);
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        .professor-cell {
            font-weight: 700;
            color: var(--brand);
            font-family: 'Playfair Display', serif;
        }
        .subject-cell {
            color: #166534;
        }
        .time-cell {
            color: #666;
            font-size: 0.9em;
        }
        .device-cell {
            background: #f8fafc;
            color: #334155;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            border: 1px solid #e2e8f0;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        /* Tabs de rango */
        .view-tabs{ display:flex; flex-wrap:wrap; gap:8px; }
        .view-tabs .tab{
            background:#f1f5f9; color:#0f172a; border:1px solid #e2e8f0;
            border-radius:999px; padding:8px 14px; font-weight:600; font-size:.9rem;
            display:inline-flex; align-items:center; gap:8px; cursor:pointer;
            transition: all .2s ease;
        }
        .view-tabs .tab:hover{ background:#e2e8f0; }
        .view-tabs .tab.active{ background:linear-gradient(135deg, var(--accent) 0%, #e9d69a 100%); color:#0f172a; border-color: rgba(197,163,81,.45); box-shadow: 0 6px 16px rgba(197,163,81,.25); }
        /* === Material-like additions for existing HTML classes === */
        .stats-grid{
            display:grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap:20px;
            margin-bottom:30px;
        }
        .stats-card{
            background: var(--card);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(15,23,42,0.06);
            border-radius: 16px;
            padding: 18px;
            display:flex;
            align-items:center;
            gap:16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.06);
            transition: transform .2s ease, box-shadow .2s ease;
        }
        .stats-card:hover{
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.12);
        }
        .card-icon{
            width:56px; height:56px; border-radius:14px;
            display:flex; align-items:center; justify-content:center;
            color:white; flex-shrink:0;
            box-shadow: 0 8px 16px rgba(0,0,0,.18);
        }
        .card-content h3{
            color: var(--muted);
            font-size: .95rem;
            font-weight: 600;
            letter-spacing: .3px;
            margin-bottom: 6px;
        }
        .stat-number{ color: var(--brand); font-weight: 700; font-size: 2rem; }
        .stat-change{ display:flex; align-items:center; gap:8px; color:#64748b; font-size:.85rem; margin-top:4px; }

        .controls-container{
            background: var(--card);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(15,23,42,.06);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,.06);
        }
        .controls-header h2{
            color: var(--brand);
            font-size: 1.2rem;
            display:flex; align-items:center; gap:10px;
        }
        .filters-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; }
        .filter-group label{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:.9rem; margin-bottom:6px; }
        .filter-group input, .filter-group select{ width:100%; }
        .action-buttons{ display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; }

        .btn-secondary{ background:#f1f5f9; color:#0f172a; border:1px solid #e2e8f0; }
        .btn-secondary:hover{ background:#e2e8f0; }
        .btn-danger{ background:#ef4444; color:white; }
        .btn-danger:hover{ background:#dc2626; }

        .table-wrapper{ overflow:auto; max-height:65vh; }
        #attendance-table thead th{ position: sticky; top:0; background:#f9fafb; z-index:1; }

        .professor-info{ display:flex; flex-direction:column; }
        .professor-info small{ color:#64748b; }
        .subject-tag{ background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; padding:6px 10px; border-radius:999px; font-size:.85rem; font-weight:600; }
        .type-badge, .aula-badge, .status-badge { 
            padding: 6px 10px; 
            border-radius: 999px; 
            font-size: .85rem; 
            font-weight: 600; 
            display: inline-flex; 
            align-items: center; 
            gap: 4px; 
        }
        
        .live-status-card {
            background: rgba(255,255,255,0.7);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .live-status-card h4 {
            margin: 0 0 12px 0;
            color: var(--brand);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .teacher-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .teacher-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(16,185,129,0.1);
            border: 1px solid rgba(16,185,129,0.2);
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .current-time {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
            font-family: 'Inter', monospace;
        }
        
        .current-period {
            color: var(--muted);
            font-size: 0.9rem;
        }
        
        .stats-mini {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-number {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--muted);
        }
        .status-badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-weight:600; font-size:.85rem; }
        .status-verified{ background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
        .table-actions .record-count{ color:var(--muted); font-weight:500; }

        .no-data-container{ background:var(--card); border:1px solid rgba(15,23,42,.06); border-radius:16px; padding:24px; text-align:center; color:var(--muted); }
        .no-data-icon{ width:56px; height:56px; border-radius:12px; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; background:#f1f5f9; color:#0f172a; }
        
    /* Summary cards (Diario / Semanal / Mensual) */
    .summary-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:16px; margin-bottom:16px; }
    .summary-card{ background: var(--card); border:1px solid rgba(15,23,42,.06); border-radius:16px; padding:14px; box-shadow: 0 10px 25px rgba(0,0,0,.06); }
    .summary-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .summary-title{ display:flex; align-items:center; gap:8px; font-weight:700; color: var(--brand); }
    .summary-meta{ color: var(--muted); font-weight:600; font-size:.9rem; }
    .summary-body{ display:flex; flex-wrap:wrap; gap:8px; max-height:120px; overflow:auto; }
    .chip{ display:inline-flex; align-items:center; gap:8px; background:#f8fafc; border:1px solid #e2e8f0; color:#0f172a; padding:6px 10px; border-radius:999px; font-weight:600; font-size:.85rem; }
    .chip .count{ background:#0ea5e9; color:white; border-radius:999px; padding:2px 6px; font-size:.75rem; font-weight:700; }
    .chip .initials{ width:22px; height:22px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; background:#e2e8f0; color:#0f172a; font-size:.75rem; font-weight:800; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <svg width="44" height="44" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <defs>
                          <linearGradient id="g" x1="0" x2="1">
                            <stop offset="0%" stop-color="#c5a351"/>
                            <stop offset="100%" stop-color="#e9d69a"/>
                          </linearGradient>
                        </defs>
                        <path d="M8 16l24-8 24 8v14c0 13.255-10.745 24-24 24S8 43.255 8 30V16z" fill="url(#g)"/>
                        <path d="M20 24h24v6H20zM20 34h24v6H20z" fill="#0f172a" opacity=".85"/>
                    </svg>
                    <div>
                        <h1>Institución Educativa Antonia Moreno de Cáceres N.º 5090</h1>
                        <p style="margin: 5px 0 0 0; color: var(--muted); font-size: 1.05rem;">Sistema Ejecutivo de Control de Asistencia</p>
                    </div>
                </div>
                <div class="header-info">
                    <div class="current-time" id="current-time"></div>
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>Sistema Activo</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen por períodos -->
        <div class="summary-grid" id="summary-grid">
            <div class="summary-card">
                <div class="summary-header">
                    <div class="summary-title"><i class="fas fa-calendar-day"></i> Diario</div>
                    <div class="summary-meta"><span id="daily-count">0</span> profesores</div>
                </div>
                <div class="summary-body" id="daily-list">
                    <!-- chips de profesores del día -->
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-header">
                    <div class="summary-title"><i class="fas fa-calendar-week"></i> Semanal</div>
                    <div class="summary-meta"><span id="weekly-count">0</span> profesores</div>
                </div>
                <div class="summary-body" id="weekly-list"></div>
            </div>
            <div class="summary-card">
                <div class="summary-header">
                    <div class="summary-title"><i class="fas fa-calendar-alt"></i> Mensual</div>
                    <div class="summary-meta"><span id="monthly-count">0</span> profesores</div>
                </div>
                <div class="summary-body" id="monthly-list"></div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stats-card">
                <div class="card-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-users"></i>
                </div>
                <div class="card-content">
                    <h3>Total Registros</h3>
                    <div class="stat-number" id="total-registros">0</div>
                    <div class="stat-change">
                        <i class="fas fa-arrow-up"></i>
                        <span>Sistema operativo</span>
                    </div>
                </div>
            </div>
            
            <div class="stats-card">
                <div class="card-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="card-content">
                    <h3>Profesores</h3>
                    <div class="stat-number" id="profesores-hoy">0</div>
                    <div class="stat-change">
                        <i class="fas fa-check-circle"></i>
                        <span id="range-label-1">Activos</span>
                    </div>
                </div>
            </div>
            
            <div class="stats-card">
                <div class="card-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="card-content">
                    <h3>Último Registro</h3>
                    <div class="stat-number" style="font-size: 1.4rem; font-weight: 500;" id="ultimo-registro">--</div>
                    <div class="stat-change">
                        <i class="fas fa-calendar"></i>
                        <span>Tiempo real</span>
                    </div>
                </div>
            </div>
            
            <div class="stats-card">
                <div class="card-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <i class="fas fa-book-open"></i>
                </div>
                <div class="card-content">
                    <h3>Materias Activas</h3>
                    <div class="stat-number" id="materias-activas">0</div>
                    <div class="stat-change">
                        <i class="fas fa-graduation-cap"></i>
                        <span>En seguimiento</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls-container">
            <div class="controls-header">
                <h2>
                    <i class="fas fa-filter"></i>
                    Filtros y Controles
                </h2>
            </div>
            <div class="controls-content">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:14px;">
                    <i class="fas fa-wand-magic-sparkles" style="color:var(--accent);"></i>
                    <input id="nl-search" type="text" placeholder="Buscar con IA (ej: 'hoy 9 matemáticas' o 'Juan Pérez esta semana')" style="flex:1;">
                    <button class="btn-primary" onclick="applyNaturalLanguage()"><i class="fas fa-bolt"></i> Interpretar</button>
                </div>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="filter-professor">
                            <i class="fas fa-user"></i>
                            Profesor
                        </label>
                        <input type="text" id="filter-professor" placeholder="Buscar por nombre...">
                    </div>
                    <div class="filter-group">
                        <label for="filter-subject">
                            <i class="fas fa-book"></i>
                            Materia
                        </label>
                        <input type="text" id="filter-subject" placeholder="Buscar por materia...">
                    </div>
                    <div class="filter-group">
                        <label for="filter-date">
                            <i class="fas fa-calendar"></i>
                            Fecha
                        </label>
                        <input type="date" id="filter-date">
                    </div>
                    <div class="filter-group">
                        <label for="filter-hour">
                            <i class="fas fa-clock"></i>
                            Hora
                        </label>
                        <select id="filter-hour">
                            <option value="">Todas las horas</option>
                            <option value="7">07:00 - 07:59</option>
                            <option value="8">08:00 - 08:59</option>
                            <option value="9">09:00 - 09:59</option>
                            <option value="10">10:00 - 10:59</option>
                            <option value="11">11:00 - 11:59</option>
                            <option value="12">12:00 - 12:59</option>
                            <option value="13">13:00 - 13:59</option>
                            <option value="14">14:00 - 14:59</option>
                            <option value="15">15:00 - 15:59</option>
                            <option value="16">16:00 - 16:59</option>
                            <option value="17">17:00 - 17:59</option>
                        </select>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" onclick="applyFilters()">
                        <i class="fas fa-search"></i>
                        Aplicar Filtros
                    </button>
                    <button class="btn-secondary" onclick="clearFilters()">
                        <i class="fas fa-times"></i>
                        Limpiar
                    </button>
                    <button class="btn-secondary" onclick="exportToCSV()">
                        <i class="fas fa-download"></i>
                        Exportar CSV
                    </button>
                    <button class="btn-success" onclick="loadRealRecords()" style="background: #22c55e;">
                        <i class="fas fa-mobile-alt"></i>
                        Cargar QR de la App
                    </button>
                    <button class="btn-danger" onclick="clearDatabase()">
                        <i class="fas fa-trash"></i>
                        Limpiar DB
                    </button>
                    <button class="btn-secondary" onclick="loadData(true)">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>
            </div>
        </div>

    <div id="loading" class="loading">
        <p>Cargando registros de asistencia...</p>
    </div>

        <!-- Insights ejecutivos -->
        <div class="header" id="insights" style="margin-bottom:20px; display:none;">
            <div style="display:flex; justify-content:space-between; gap:16px; flex-wrap:wrap; align-items:flex-start;">
                <div style="flex:1; min-width:260px;">
                    <h3 style="font-family:'Playfair Display',serif; color:var(--brand); font-size:1.2rem; margin-bottom:8px;">
                        <i class="fas fa-brain" style="color:var(--accent);"></i> Insights del Día
                    </h3>
                    <ul id="insights-list" style="color:#475569; line-height:1.65; padding-left:18px;">
                        <!-- Se llena por JS -->
                    </ul>
                </div>
                <div style="min-width:260px;">
                    <div style="background:rgba(197,163,81,0.08); border:1px solid rgba(197,163,81,0.25); padding:14px 16px; border-radius:14px; color:#6b7280;">
                        <div style="font-weight:600; color:var(--brand); margin-bottom:6px;">
                            Recomendación
                        </div>
                        <div id="insight-reco">Optimice la toma de asistencia entre 7:50 y 8:10 para reducir congestionamientos.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estado en Tiempo Real -->
        <div class="header" id="live-status" style="margin-bottom:20px;">
            <h3 style="font-family:'Playfair Display',serif; color:var(--brand); font-size:1.4rem; margin-bottom:16px;">
                <i class="fas fa-signal" style="color:var(--accent);"></i> Estado en Tiempo Real
            </h3>
            <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:16px;">
                <div class="live-status-card">
                    <h4><i class="fas fa-users"></i> Profesores Activos</h4>
                    <div id="active-teachers" class="teacher-list">
                        <!-- Se llena por JS -->
                    </div>
                </div>
                <div class="live-status-card">
                    <h4><i class="fas fa-clock"></i> Horario Actual</h4>
                    <div id="current-schedule">
                        <div class="current-time" id="current-time">--:--:--</div>
                        <div class="current-period" id="current-period">Calculando período...</div>
                    </div>
                </div>
                <div class="live-status-card">
                    <h4><i class="fas fa-chart-line"></i> Resumen Hoy</h4>
                    <div class="stats-mini">
                        <div class="stat-item">
                            <span class="stat-number" id="today-entries">0</span>
                            <span class="stat-label">Entradas</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="today-exits">0</span>
                            <span class="stat-label">Salidas</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="today-late">0</span>
                            <span class="stat-label">Tardanzas</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-container" id="table-section" style="display: none;">
            <div class="table-header">
                <h2>
                    <i class="fas fa-table"></i>
                    Registros de Asistencia
                </h2>
                <div class="table-actions">
                    <span class="record-count">Total: <span id="record-count">0</span> registros</span>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="attendance-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-user"></i> Profesor</th>
                            <th><i class="fas fa-door-open"></i> Tipo</th>
                            <th><i class="fas fa-chalkboard"></i> Aula</th>
                            <th><i class="fas fa-book"></i> Materia</th>
                            <th><i class="fas fa-calendar"></i> Fecha</th>
                            <th><i class="fas fa-clock"></i> Hora</th>
                            <th><i class="fas fa-traffic-light"></i> Estado</th>
                            <th><i class="fas fa-mobile-alt"></i> Dispositivo</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="no-data" class="no-data-container" style="display: none;">
            <div class="no-data-icon">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <h3>No hay registros disponibles</h3>
            <p>Los registros de asistencia aparecerán aquí cuando los profesores escaneen sus códigos QR.</p>
            <button class="btn-primary" onclick="loadData(true)">
                <i class="fas fa-sync-alt"></i>
                Verificar Actualizaciones
            </button>
        </div>

    </div> <!-- Cierre del container principal -->

    <!-- Mock API para GitHub Pages -->
    <script src="mock-api.js"></script>
    
    <script>
    // Permitir configurar el backend vía querystring (?server=URL) o localStorage
    // Uso: https://tu-usuario.github.io/attendance-qr-app/attendance_qr/web/dashboard.html?server=https://tu-backend.vercel.app
    (function(){
        try{
            const qs = new URLSearchParams(window.location.search);
            const qServer = qs.get('server');
            if(qServer){
                localStorage.setItem('SERVER_URL', qServer);
            }
        }catch(_){/* ignore */}
    })();
    const SERVER_URL = (function(){
        try{
            const saved = localStorage.getItem('SERVER_URL');
            if (saved && /^https?:\/\//i.test(saved)) return saved;
        }catch(_){/* ignore */}
        
        // Auto-detectar entorno
        if (window.location.hostname === 'stylo3066.github.io') {
            // GitHub Pages: usar mock API (ya está interceptado)
            return window.location.origin;
        } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            // Desarrollo local
            return 'http://localhost:3000';
        } else {
            // Red local (IP específica)
            return 'http://192.168.100.7:3000';
        }
    })();
        let allAttendanceData = [];
        let filteredData = [];
        
        // Base de datos de horarios de profesores
        const TEACHER_SCHEDULES = {
            "47045355": { // ALOCILLA FRANCO
                name: "ALOCILLA FERNANDEZ, FRANCO ANDREE",
                nivel: "Secundaria",
                schedule: {
                    "Lunes": [
                        { hora: "7:30-9:00", aula: "3B", materia: "Matemática" },
                        { hora: "9:00-10:30", aula: "4B", materia: "Matemática" },
                        { hora: "10:30-10:45", aula: "RECREO", materia: "Recreo" },
                        { hora: "10:45-11:30", aula: "LIBRE", materia: "Libre" },
                        { hora: "11:30-13:00", aula: "3A", materia: "Matemática" }
                    ],
                    "Martes": [
                        { hora: "7:30-9:00", aula: "3A", materia: "Matemática" },
                        { hora: "9:00-9:45", aula: "LIBRE", materia: "Libre" },
                        { hora: "9:45-10:30", aula: "4A", materia: "Matemática" },
                        { hora: "10:30-10:45", aula: "RECREO", materia: "Recreo" },
                        { hora: "10:45-11:30", aula: "4A", materia: "Matemática" },
                        { hora: "11:30-12:15", aula: "4B", materia: "Matemática" },
                        { hora: "12:15-13:00", aula: "4B", materia: "Matemática" }
                    ],
                    "Miércoles": [
                        { hora: "7:30-9:00", aula: "5B", materia: "Ciencia y Tecnología" },
                        { hora: "9:00-10:30", aula: "4A", materia: "Matemática" },
                        { hora: "10:30-10:45", aula: "RECREO", materia: "Recreo" },
                        { hora: "10:45-11:30", aula: "3B", materia: "Matemática" },
                        { hora: "11:30-12:15", aula: "LIBRE", materia: "Libre" },
                        { hora: "12:15-13:00", aula: "LIBRE", materia: "Libre" }
                    ],
                    "Jueves": [
                        { hora: "7:30-9:00", aula: "4A", materia: "Matemática" },
                        { hora: "9:00-10:30", aula: "3B", materia: "Matemática" },
                        { hora: "10:30-10:45", aula: "RECREO", materia: "Recreo" },
                        { hora: "10:45-11:30", aula: "LIBRE", materia: "Libre" },
                        { hora: "11:30-13:00", aula: "5B", materia: "Ciencia y Tecnología" }
                    ],
                    "Viernes": [
                        { hora: "7:30-9:00", aula: "4B", materia: "Matemática" },
                        { hora: "9:00-9:45", aula: "LIBRE", materia: "Libre" },
                        { hora: "9:45-10:30", aula: "3A", materia: "Matemática" },
                        { hora: "10:30-10:45", aula: "RECREO", materia: "Recreo" },
                        { hora: "10:45-11:30", aula: "COLEGIADA", materia: "Colegiada" },
                        { hora: "11:30-13:00", aula: "LIBRE", materia: "Libre" }
                    ]
                }
            }
        };

        // Función para obtener el horario actual del profesor
        function getCurrentSchedule(professorId) {
            const now = new Date();
            const dayName = now.toLocaleLowerString('es-ES', { weekday: 'long' });
            const dayMap = {
                'lunes': 'Lunes', 'martes': 'Martes', 'miércoles': 'Miércoles', 
                'jueves': 'Jueves', 'viernes': 'Viernes'
            };
            const day = dayMap[dayName];
            
            const teacher = TEACHER_SCHEDULES[professorId];
            if (!teacher || !teacher.schedule[day]) return null;
            
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            for (let slot of teacher.schedule[day]) {
                const [start, end] = slot.hora.split('-');
                const [startH, startM] = start.split(':').map(Number);
                const [endH, endM] = end.split(':').map(Number);
                
                const startTime = startH * 60 + startM;
                const endTime = endH * 60 + endM;
                
                if (currentTime >= startTime && currentTime <= endTime) {
                    return { ...slot, teacher: teacher.name, nivel: teacher.nivel };
                }
            }
            return null;
        }

        // Datos de ejemplo con sistema real de entrada/salida
        const DEMO_DATA = [
            {
                professorId: "47045355", // ALOCILLA FRANCO
                professorFullName: "ALOCILLA FERNANDEZ, FRANCO ANDREE",
                subject: "Matemática",
                aula: "3B",
                date: new Date().toISOString().split('T')[0],
                hour: 8,
                time: "07:35:20",
                type: "ENTRADA",
                status: "PUNTUAL",
                serverTimestamp: new Date(Date.now() - 3600000).toISOString(),
                deviceId: "Android-12345",
                currentSchedule: getCurrentSchedule("47045355")
            },
            {
                professorId: "40770563", // CANO AVILA ROCIO
                professorFullName: "CANO AVILA, ROCIO PILAR",
                subject: "Primaria",
                aula: "1A",
                date: new Date().toISOString().split('T')[0],
                hour: 7,
                time: "07:28:15",
                type: "ENTRADA", 
                status: "PUNTUAL",
                serverTimestamp: new Date(Date.now() - 7200000).toISOString(),
                deviceId: "iOS-67890"
            },
            {
                professorId: "42029091", // CHAMBI TORRES JANNETH
                professorFullName: "CHAMBI TORRES, JANNETH CARLA",
                subject: "Primaria",
                aula: "2B",
                date: new Date().toISOString().split('T')[0],
                hour: 7,
                time: "07:45:30",
                type: "ENTRADA",
                status: "TARDANZA",
                serverTimestamp: new Date(Date.now() - 6300000).toISOString(),
                deviceId: "Android-54321"
            },
            {
                professorId: "47045355", // ALOCILLA FRANCO (SALIDA)
                professorFullName: "ALOCILLA FERNANDEZ, FRANCO ANDREE",
                subject: "Matemática",
                aula: "4B",
                date: new Date().toISOString().split('T')[0],
                hour: 13, 
                time: "13:05:10",
                type: "SALIDA",
                status: "COMPLETO",
                serverTimestamp: new Date(Date.now() - 300000).toISOString(),
                deviceId: "Android-12345"
            },
            {
                professorId: "25691722", // CASTRO FALCON DAVID
                professorFullName: "CASTRO FALCON, DAVID ALBERTO", 
                subject: "Historia",
                aula: "5A",
                date: new Date().toISOString().split('T')[0],
                hour: 8,
                time: "08:10:45",
                type: "ENTRADA",
                status: "TARDANZA",
                serverTimestamp: new Date(Date.now() - 5400000).toISOString(),
                deviceId: "iOS-98765"
            },
            {
                professorId: "40770563", // CANO AVILA ROCIO (SALIDA)
                professorFullName: "CANO AVILA, ROCIO PILAR",
                subject: "Primaria",
                aula: "1A",
                date: new Date().toISOString().split('T')[0],
                hour: 13,
                time: "13:02:20",
                type: "SALIDA",
                status: "COMPLETO",
                serverTimestamp: new Date(Date.now() - 180000).toISOString(),
                deviceId: "iOS-67890"
            }
        ];
        
        function toDateOnly(dateStr){
            if(!dateStr) return null;
            return new Date(dateStr + 'T00:00:00');
        }
        function daysDiff(a,b){
            const ms = Math.abs(a.getTime() - b.getTime());
            return Math.floor(ms/86400000);
        }

        // Función para actualizar el reloj en tiempo real
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            const dateString = now.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const clockElement = document.getElementById('current-time');
            if (clockElement) {
                clockElement.innerHTML = `${timeString}<br><small>${dateString}</small>`;
            }
        }

        // Actualizar reloj cada segundo
        setInterval(updateClock, 1000);
        updateClock(); // Llamar inmediatamente

    async function loadData(showMessage = false) {
            try {
                // Intentar cargar datos del servidor
                const response = await fetch(`${SERVER_URL}/api/attendance`);
                const prev = allAttendanceData || [];
                allAttendanceData = await response.json();
                
                // Si no hay datos del servidor, usar datos demo
                if (allAttendanceData.length === 0) {
                    throw new Error('No server data available');
                }
                
            } catch (error) {
                console.log('Usando datos de demostración (servidor no disponible)');
                
                // Usar datos demo + datos guardados localmente
                const savedData = JSON.parse(localStorage.getItem('attendanceDemo') || '[]');
                allAttendanceData = [...DEMO_DATA, ...savedData];
                
                // Agregar timestamp más reciente para simular actividad
                if (Math.random() > 0.7) {
                    const newDemo = {
                        professorId: "DEMO" + Math.floor(Math.random() * 100),
                        professorFullName: "Profesor Demo " + Math.floor(Math.random() * 50),
                        subject: ["Matemáticas", "Historia", "Ciencias", "Literatura", "Educación Física"][Math.floor(Math.random() * 5)],
                        date: new Date().toISOString().split('T')[0],
                        hour: Math.floor(Math.random() * 11) + 7,
                        time: new Date().toLocaleTimeString('es-ES'),
                        serverTimestamp: new Date().toISOString(),
                        deviceId: "Demo-Device"
                    };
                    allAttendanceData.push(newDemo);
                }
            }
            
            // Ordenar por timestamp más reciente primero
            allAttendanceData.sort((a, b) => new Date(b.serverTimestamp) - new Date(a.serverTimestamp));
            
            filteredData = [...allAttendanceData];
            updateStats();
            renderTable();
            buildInsights();
            buildRangeSummary();
            updateLiveStatus();
            
            document.getElementById('loading').style.display = 'none';
            
            if (showMessage && allAttendanceData.length > 0) {
                console.log(`${allAttendanceData.length} registros cargados`);
            }
        }

        function showToast(msg){
            let t = document.getElementById('toast');
            if(!t){
                t = document.createElement('div');
                t.id='toast';
                t.style.position='fixed'; t.style.bottom='24px'; t.style.right='24px';
                t.style.background='rgba(30,41,59,0.9)'; t.style.color='white';
                t.style.padding='12px 16px'; t.style.borderRadius='12px';
                t.style.boxShadow='0 10px 20px rgba(0,0,0,.2)';
                t.style.zIndex='9999';
                document.body.appendChild(t);
            }
            t.textContent = msg;
            t.style.opacity='1';
            setTimeout(()=>{ t.style.transition='opacity .6s'; t.style.opacity='0'; }, 2500);
        }

        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = allAttendanceData.filter(record => record.date === today);
            
            // Actualizar estadísticas
            document.getElementById('total-registros').textContent = allAttendanceData.length;
            document.getElementById('profesores-hoy').textContent = 
                new Set(allAttendanceData.map(r => r.professorId)).size;
            
            // Último registro
            if (allAttendanceData.length > 0) {
                const lastRecord = allAttendanceData[0];
                const lastTime = new Date(lastRecord.serverTimestamp);
                document.getElementById('ultimo-registro').textContent = 
                    lastTime.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            } else {
                document.getElementById('ultimo-registro').textContent = '--:--';
            }
            
            // Contar materias únicas
            const uniqueSubjects = new Set(allAttendanceData.map(r => r.subject));
            document.getElementById('materias-activas').textContent = uniqueSubjects.size;
        }

        function renderTable() {
            const tbody = document.getElementById('attendance-tbody');
            const tableSection = document.getElementById('table-section');
            const noData = document.getElementById('no-data');
            const recordCount = document.getElementById('record-count');
            
            if (filteredData.length === 0) {
                tableSection.style.display = 'none';
                noData.style.display = 'block';
                return;
            }
            
            // Actualizar contador de registros
            if (recordCount) {
                recordCount.textContent = filteredData.length;
            }
            
            tableSection.style.display = 'block';
            noData.style.display = 'none';
            
            tbody.innerHTML = filteredData.map(record => {
                const timestamp = new Date(record.serverTimestamp);
                const formattedDate = timestamp.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: '2-digit'
                });
                const formattedTime = timestamp.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                // Determinar colores y iconos según el tipo y estado
                const typeInfo = record.type === 'ENTRADA' ? 
                    { icon: 'fa-sign-in-alt', color: '#10b981', text: 'ENTRADA' } : 
                    { icon: 'fa-sign-out-alt', color: '#ef4444', text: 'SALIDA' };
                
                const statusInfo = {
                    'PUNTUAL': { icon: 'fa-check-circle', color: '#10b981', text: 'PUNTUAL' },
                    'TARDANZA': { icon: 'fa-exclamation-triangle', color: '#f59e0b', text: 'TARDANZA' },
                    'COMPLETO': { icon: 'fa-check-double', color: '#06b6d4', text: 'COMPLETO' }
                }[record.status] || { icon: 'fa-question-circle', color: '#6b7280', text: record.status };

                return `
                    <tr>
                        <td>
                            <div class="professor-info">
                                <strong>${record.professorFullName || record.professorName + ' ' + (record.professorLastName || '')}</strong>
                                <small>${record.professorId}</small>
                            </div>
                        </td>
                        <td>
                            <span class="type-badge" style="background-color: ${typeInfo.color}15; color: ${typeInfo.color}; border: 1px solid ${typeInfo.color}30;">
                                <i class="fas ${typeInfo.icon}"></i>
                                ${typeInfo.text}
                            </span>
                        </td>
                        <td>
                            <span class="aula-badge" style="background-color: #3b82f615; color: #3b82f6; border: 1px solid #3b82f630;">
                                <i class="fas fa-chalkboard"></i>
                                ${record.aula || 'N/A'}
                            </span>
                        </td>
                        <td>
                            <span class="subject-tag">${record.subject || 'N/A'}</span>
                        </td>
                        <td>${formattedDate}</td>
                        <td>${formattedTime}</td>
                        <td>
                            <span class="status-badge" style="background-color: ${statusInfo.color}15; color: ${statusInfo.color}; border: 1px solid ${statusInfo.color}30;">
                                <i class="fas ${statusInfo.icon}"></i>
                                ${statusInfo.text}
                            </span>
                        </td>
                        <td>
                            <small style="color: #64748b;">${record.deviceId || 'Dispositivo móvil'}</small>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function buildInsights(){
            const insightsBox = document.getElementById('insights');
            const list = document.getElementById('insights-list');
            if(!allAttendanceData || allAttendanceData.length === 0){
                insightsBox.style.display = 'none';
                return;
            }
            insightsBox.style.display = 'block';
            const today = new Date().toISOString().split('T')[0];
            const todayRecs = allAttendanceData.filter(r => r.date === today);
            // llegadas por hora
            const byHour = {};
            allAttendanceData.forEach(r => { const h = (r.hour||new Date(r.serverTimestamp).getHours()).toString().padStart(2,'0'); byHour[h]=(byHour[h]||0)+1; });
            const topHour = Object.entries(byHour).sort((a,b)=>b[1]-a[1])[0];
            // materias top
            const bySubject = {};
            allAttendanceData.forEach(r=>{ const s=r.subject||'N/A'; bySubject[s]=(bySubject[s]||0)+1; });
            const topSubject = Object.entries(bySubject).sort((a,b)=>b[1]-a[1])[0];
            // profesores con múltiples registros hoy
            const byProf = {};
            todayRecs.forEach(r=>{ const p=r.professorId; byProf[p]=(byProf[p]||0)+1; });
            const multi = Object.entries(byProf).filter(([,c])=>c>1).length;

            list.innerHTML = `
                <li>Registros hoy: <strong>${todayRecs.length}</strong> (${allAttendanceData.length} total).</li>
                <li>Franja más concurrida: <strong>${topHour ? topHour[0]+':00' : '—'}</strong> con ${topHour?topHour[1]:0} registros.</li>
                <li>Materia más registrada: <strong>${topSubject?topSubject[0]:'—'}</strong>.</li>
                <li>Profesores con múltiples registros hoy: <strong>${multi}</strong>.</li>
            `;
        }

        function applyNaturalLanguage(){
            const q = (document.getElementById('nl-search').value||'').toLowerCase();
            // Reset filtros visibles
            document.getElementById('filter-professor').value = '';
            document.getElementById('filter-subject').value = '';
            document.getElementById('filter-date').value = '';
            document.getElementById('filter-hour').value = '';

            // reglas simples: 'hoy', 'ayer', hora (7,8,9..), materia palabra, nombre
            const today = new Date();
            const iso = d=>d.toISOString().split('T')[0];
            if(q.includes('hoy')){
                document.getElementById('filter-date').value = iso(today);
            } else if(q.includes('ayer')){
                const d = new Date(); d.setDate(today.getDate()-1);
                document.getElementById('filter-date').value = iso(d);
            } else if(q.includes('semana')){
                // para semana, no hay filtro múltiple; dejamos sin date y lo indicamos en insights
            }

            const hourMatch = q.match(/\b(7|8|9|10|11|12|13|14|15|16|17)\b/);
            if(hourMatch){
                document.getElementById('filter-hour').value = hourMatch[1];
            }

            // Materia: tomamos primera palabra no numérica relevante
            const maybeSubject = q.replace(/\b(hoy|ayer|semana|de|la|el|los|las)\b/g,'').trim();
            if(maybeSubject && maybeSubject.length>2){
                document.getElementById('filter-subject').value = maybeSubject;
            }

            // Nombre profesor heurística: si contiene espacio y >4
            if(q.split(' ').length>=2 && q.length>6){
                document.getElementById('filter-professor').value = q;
            }

            applyFilters();
        }

        function applyFilters() {
            const professorFilter = document.getElementById('filter-professor').value.toLowerCase();
            const subjectFilter = document.getElementById('filter-subject').value.toLowerCase();
            const dateFilter = document.getElementById('filter-date').value;
            const hourFilter = document.getElementById('filter-hour').value;
            
            filteredData = allAttendanceData.filter(record => {
                const matchesProfessor = !professorFilter || 
                    (record.professorFullName || '').toLowerCase().includes(professorFilter);
                
                const matchesSubject = !subjectFilter || 
                    (record.subject || '').toLowerCase().includes(subjectFilter);
                
                const matchesDate = !dateFilter || record.date === dateFilter;
                
                const matchesHour = !hourFilter || record.hour == hourFilter;
                
                return matchesProfessor && matchesSubject && matchesDate && matchesHour;
            });
            
            renderTable();
        }

        function clearFilters() {
            document.getElementById('filter-professor').value = '';
            document.getElementById('filter-subject').value = '';
            document.getElementById('filter-date').value = '';
            document.getElementById('filter-hour').value = '';
            filteredData = [...allAttendanceData];
            renderTable();
        }

        function exportToCSV() {
            if (filteredData.length === 0) {
                alert('No hay datos para exportar');
                return;
            }
            
            const headers = ['Profesor', 'Materia', 'Fecha', 'Hora', 'Dispositivo', 'Timestamp'];
            const csvContent = [
                headers.join(','),
                ...filteredData.map(record => [
                    `"${record.professorFullName || record.professorName + ' ' + (record.professorLastName || '')}"`,
                    `"${record.subject || 'N/A'}"`,
                    record.date || new Date(record.serverTimestamp).toLocaleDateString('es-ES'),
                    record.time || new Date(record.serverTimestamp).toLocaleTimeString('es-ES'),
                    record.deviceId,
                    record.serverTimestamp
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `asistencia_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function clearDatabase() {
            if (confirm('¿Estás seguro de que quieres eliminar todos los registros?')) {
                try {
                    await fetch(`${SERVER_URL}/api/attendance`, { method: 'DELETE' });
                    localStorage.removeItem('attendanceDemo');
                    allAttendanceData = [];
                    filteredData = [];
                    updateStats();
                    renderTable();
                    alert('Base de datos limpiada');
                } catch (error) {
                    // Si no hay servidor, limpiar localStorage
                    localStorage.removeItem('attendanceDemo');
                    allAttendanceData = [...DEMO_DATA];
                    filteredData = [...allAttendanceData];
                    updateStats();
                    renderTable();
                    alert('Datos demo reiniciados');
                }
            }
        }

        // Función para cargar registros reales de la app Flutter
        function loadRealRecords() {
            const realRecords = [
                {
                    id: '1729664840893',
                    qrCode: '47045355',
                    deviceId: 'flutter_app',
                    timestamp: '2025-10-23T07:27:20.893Z',
                    professorId: '47045355',
                    professorFullName: 'ALOCILLA FERNANDEZ, FRANCO ANDREE',
                    subject: 'Matemática',
                    serverTimestamp: '2025-10-23T07:27:20.893Z',
                    date: '2025-10-23',
                    time: '07:27:20',
                    hour: 7,
                    type: 'ENTRADA',
                    status: 'PUNTUAL',
                    verified: true
                },
                {
                    id: '1729664855726',
                    qrCode: '47045355',
                    deviceId: 'flutter_app',
                    timestamp: '2025-10-23T07:27:35.726Z',
                    professorId: '47045355',
                    professorFullName: 'ALOCILLA FERNANDEZ, FRANCO ANDREE',
                    subject: 'Matemática',
                    serverTimestamp: '2025-10-23T07:27:35.726Z',
                    date: '2025-10-23',
                    time: '07:27:35',
                    hour: 7,
                    type: 'SALIDA',
                    status: 'PUNTUAL',
                    verified: true
                }
            ];

            // Agregar registros reales a los datos existentes
            realRecords.forEach(record => {
                // Verificar si no existe ya
                if (!allAttendanceData.some(r => r.id === record.id)) {
                    allAttendanceData.push(record);
                }
            });

            // Actualizar vista
            filteredData = [...allAttendanceData];
            updateStats();
            renderTable();
            
            alert('✅ Registros QR de la app cargados correctamente!\n\n📱 Franco Andree - 2 registros\n🕐 Entrada: 07:27:20\n🕑 Salida: 07:27:35');
        }

        // Auto-actualizar cada 10 segundos
        setInterval(() => loadData(), 10000);

        // Cargar datos al inicio
        function buildRangeSummary(){
            const now = new Date();
            const todayIso = now.toISOString().split('T')[0];

            const inLast7 = (d) => daysDiff(now, d) <= 6 && d <= now;
            const isThisMonth = (d) => d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();

            const dailyMap = new Map();
            const weeklyMap = new Map();
            const monthlyMap = new Map();

            (allAttendanceData||[]).forEach(r => {
                const d = r.date ? toDateOnly(r.date) : new Date(r.serverTimestamp);
                const name = (r.professorFullName || ((r.professorName||'') + ' ' + (r.professorLastName||''))).trim();
                const key = r.professorId || name;
                if(r.date === todayIso){
                    dailyMap.set(key, { name, count: (dailyMap.get(key)?.count||0)+1 });
                }
                if(d && inLast7(d)){
                    weeklyMap.set(key, { name, count: (weeklyMap.get(key)?.count||0)+1 });
                }
                if(d && isThisMonth(d)){
                    monthlyMap.set(key, { name, count: (monthlyMap.get(key)?.count||0)+1 });
                }
            });

            const fill = (map, listId, countId) => {
                const listEl = document.getElementById(listId);
                const countEl = document.getElementById(countId);
                if(!listEl || !countEl) return;
                const arr = Array.from(map.values()).sort((a,b)=> b.count - a.count || a.name.localeCompare(b.name));
                countEl.textContent = arr.length;
                const limited = arr.slice(0, 12);
                const more = arr.length - limited.length;
                listEl.innerHTML = limited.map(p => {
                    const initials = p.name.split(' ').map(x=>x[0]).filter(Boolean).slice(0,2).join('').toUpperCase();
                    return `<span class="chip"><span class="initials">${initials}</span>${p.name} <span class="count">${p.count}</span></span>`;
                }).join('') + (more>0 ? `<span class="chip" title="y ${more} más">+${more}</span>` : '');
            };

            fill(dailyMap, 'daily-list', 'daily-count');
            fill(weeklyMap, 'weekly-list', 'weekly-count');
            fill(monthlyMap, 'monthly-list', 'monthly-count');
        }

        // Funciones para estado en tiempo real
        function updateLiveStatus() {
            updateCurrentTime();
            updateActiveTeachers();
            updateTodayStats();
        }
        
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('current-time').textContent = timeStr;
            
            // Determinar período actual
            const hour = now.getHours();
            const minute = now.getMinutes();
            const currentTime = hour * 60 + minute;
            
            let period = 'Fuera de horario escolar';
            if (currentTime >= 450 && currentTime < 540) { // 7:30-9:00
                period = '1er Período (7:30-9:00)';
            } else if (currentTime >= 540 && currentTime < 630) { // 9:00-10:30
                period = '2do Período (9:00-10:30)';
            } else if (currentTime >= 630 && currentTime < 645) { // 10:30-10:45
                period = 'RECREO (10:30-10:45)';
            } else if (currentTime >= 645 && currentTime < 690) { // 10:45-11:30
                period = '3er Período (10:45-11:30)';
            } else if (currentTime >= 690 && currentTime < 735) { // 11:30-12:15
                period = '4to Período (11:30-12:15)';
            } else if (currentTime >= 735 && currentTime < 780) { // 12:15-13:00
                period = '5to Período (12:15-13:00)';
            }
            
            document.getElementById('current-period').textContent = period;
        }
        
        function updateActiveTeachers() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = allAttendanceData.filter(record => record.date === today);
            
            // Calcular profesores activos (tienen entrada pero no salida)
            const activeTeachers = [];
            const teacherStatus = {};
            
            // Procesar registros cronológicamente
            todayData
                .sort((a, b) => new Date(a.serverTimestamp) - new Date(b.serverTimestamp))
                .forEach(record => {
                    if (record.type === 'ENTRADA') {
                        teacherStatus[record.professorId] = {
                            name: record.professorFullName,
                            aula: record.aula,
                            subject: record.subject,
                            entryTime: record.time,
                            active: true
                        };
                    } else if (record.type === 'SALIDA') {
                        if (teacherStatus[record.professorId]) {
                            teacherStatus[record.professorId].active = false;
                        }
                    }
                });
            
            // Filtrar solo los activos
            Object.values(teacherStatus)
                .filter(teacher => teacher.active)
                .forEach(teacher => activeTeachers.push(teacher));
            
            const container = document.getElementById('active-teachers');
            if (activeTeachers.length === 0) {
                container.innerHTML = '<div style="color: #6b7280; font-style: italic;">No hay profesores activos registrados</div>';
            } else {
                container.innerHTML = activeTeachers.map(teacher => `
                    <div class="teacher-item">
                        <div>
                            <strong>${teacher.name.split(',')[0]}</strong>
                            <div style="font-size: 0.8rem; color: #6b7280;">${teacher.aula} • ${teacher.subject}</div>
                        </div>
                        <div style="font-size: 0.8rem; color: #10b981;">${teacher.entryTime}</div>
                    </div>
                `).join('');
            }
        }
        
        function updateTodayStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = allAttendanceData.filter(record => record.date === today);
            
            const entries = todayData.filter(r => r.type === 'ENTRADA').length;
            const exits = todayData.filter(r => r.type === 'SALIDA').length;
            const late = todayData.filter(r => r.status === 'TARDANZA').length;
            
            document.getElementById('today-entries').textContent = entries;
            document.getElementById('today-exits').textContent = exits;
            document.getElementById('today-late').textContent = late;
        }

        window.addEventListener('load', () => { 
            loadData(); 
            updateLiveStatus();
            // Actualizar cada 30 segundos
            setInterval(updateLiveStatus, 30000);
        });

        // Aplicar filtros en tiempo real
        document.getElementById('filter-professor').addEventListener('input', applyFilters);
        document.getElementById('filter-subject').addEventListener('input', applyFilters);
        document.getElementById('filter-date').addEventListener('change', applyFilters);
        document.getElementById('filter-hour').addEventListener('change', applyFilters);
    </script>
</body>
</html>